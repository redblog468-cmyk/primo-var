<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>3D –í–ò–î–ï–û–õ–ê–ù–î–®–ê–§–¢ ¬∑ 160–ö ¬∑ –ê–£–î–ò–û –†–ï–ê–ö–¶–ò–Ø</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }
        #mainCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        #reserveCanvas {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 900px;
            height: 250px;
            border: 3px solid #00ffff;
            border-radius: 12px;
            z-index: 2;
            box-shadow: 0 0 30px #00ffff;
            background: #0a0a1a;
        }
        .controls {
            position: fixed;
            top: 290px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 3;
            background: rgba(0,0,0,0.7);
            padding: 12px 20px;
            border-radius: 50px;
            border: 1px solid #ff00ff;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn {
            background: transparent;
            color: #fff;
            border: 1px solid #ff00ff;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: 0.2s;
            font-size: 14px;
        }
        .btn:hover {
            background: #ff00ff;
            color: #000;
            box-shadow: 0 0 20px #ff00ff;
        }
        .btn.upload {
            border-color: #00ffff;
        }
        .btn.upload:hover {
            background: #00ffff;
            color: #000;
            box-shadow: 0 0 20px #00ffff;
        }
        .btn.audio {
            border-color: #ffff00;
        }
        .btn.audio:hover {
            background: #ffff00;
            color: #000;
            box-shadow: 0 0 20px #ffff00;
        }
        #videoInput, #audioInput { display: none; }
        .stats {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00ffff;
            color: #00ffff;
            z-index: 3;
            font-size: 13px;
            line-height: 1.8;
            min-width: 240px;
        }
        .label {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #ff00ff;
            font-size: 14px;
            z-index: 3;
            text-shadow: 0 0 10px #ff00ff;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }
        .counter {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: #00ffff;
            font-size: 12px;
            z-index: 3;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #00ffff;
        }
        .audio-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #ffff00;
            font-size: 14px;
            z-index: 3;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #ffff00;
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    <canvas id="reserveCanvas" width="900" height="250"></canvas>
    
    <div class="label">üåÄ –í–ò–î–ï–û–õ–ê–ù–î–®–ê–§–¢ ¬∑ 160–ö ¬∑ –ê–£–î–ò–û –†–ï–ê–ö–¶–ò–Ø</div>
    <div class="counter">‚ö° –ß–ê–°–¢–ò–¶: 160K</div>
    <div class="audio-indicator" id="audioIndicator">üîá –ê–£–î–ò–û: –ù–ï–¢</div>
    
    <div class="controls">
        <input type="file" id="videoInput" accept="video/*">
        <button class="btn upload" id="uploadVideoBtn">üìπ –ó–ê–ì–†–£–ó–ò–¢–¨ –í–ò–î–ï–û</button>
        
        <input type="file" id="audioInput" accept="audio/*">
        <button class="btn audio" id="uploadAudioBtn">üéµ –ê–£–î–ò–û–§–ê–ô–õ (–î–ò–ö–¢–û–§–û–ù)</button>
        
        <button class="btn" id="playBtn">‚ñ∂ PLAY</button>
        <button class="btn" id="pauseBtn">‚è∏ PAUSE</button>
    </div>
    
    <div class="stats" id="stats">
        <div>–ß–ê–°–¢–ò–¶: <span id="count">160K</span></div>
        <div>–ì–õ–£–ë–ò–ù–ê: <span id="depth">0%</span></div>
        <div>FPS: <span id="fps">0</span></div>
        <div>–í–ò–î–ï–û: <span id="videoStatus">–Ω–µ—Ç</span></div>
        <div>–ê–£–î–ò–û: <span id="audioStatus">–Ω–µ—Ç</span></div>
        <div>–ì–†–û–ú–ö–û–°–¢–¨: <span id="volume">0%</span></div>
        <div>–ë–ê–°: <span id="bass">0%</span></div>
        <div>–°–†–ï–î–ù–ò–ï: <span id="mid">0%</span></div>
        <div>–í–ß: <span id="high">0%</span></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    
    <script>
        (function() {
            // ==================== –ö–û–ù–§–ò–ì ====================
            const MAX_PARTICLES = 160000;
            const VIDEO_WIDTH = 320;
            const VIDEO_HEIGHT = 180;
            
            // ==================== –≠–õ–ï–ú–ï–ù–¢–´ ====================
            const mainCanvas = document.getElementById('mainCanvas');
            const reserveCanvas = document.getElementById('reserveCanvas');
            const reserveCtx = reserveCanvas.getContext('2d');
            
            // ==================== THREE.JS ====================
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510);
            
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(18, 10, 35);
            
            const renderer = new THREE.WebGLRenderer({ canvas: mainCanvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.3;
            
            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            scene.add(new THREE.AmbientLight(0x404080));
            const light1 = new THREE.PointLight(0xff88ff, 1.2, 50);
            light1.position.set(5, 10, 7);
            scene.add(light1);
            const light2 = new THREE.PointLight(0x88ffff, 0.8, 50);
            light2.position.set(-5, -5, 10);
            scene.add(light2);
            
            // ==================== –í–ò–î–ï–û ====================
            const video = document.createElement('video');
            video.crossOrigin = 'anonymous';
            video.loop = true;
            video.muted = false; // –í–ò–î–ï–û –°–û –ó–í–£–ö–û–ú
            
            // ==================== –ê–£–î–ò–û ====================
            let audioContext = null;
            let analyser = null;
            let audioSource = null;
            let audioElement = null;
            
            // ==================== –î–ê–ù–ù–´–ï –ß–ê–°–¢–ò–¶ ====================
            const whiteNoise = [];
            const particles = [];
            const spheres = [];
            const sphereGeom = new THREE.SphereGeometry(0.1, 4);
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ
            const state = {
                time: 0,
                frameCount: 0,
                lastFpsUpdate: performance.now(),
                fps: 0,
                videoActive: false,
                audioActive: false,
                frequencies: new Uint8Array(512),
                volume: 0,
                bass: 0,
                mid: 0,
                high: 0
            };
            
            // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø ====================
            function generateWhiteNoise() {
                for (let i = 0; i < MAX_PARTICLES; i++) {
                    whiteNoise.push({
                        rx: (Math.random() - 0.5) * 900,
                        ry: (Math.random() - 0.5) * 280
                    });
                    
                    particles.push({
                        r: 255, g: 255, b: 255,
                        depth: 0.5,
                        phase: Math.random() * Math.PI * 2,
                        freqResponse: 0
                    });
                }
                document.getElementById('count').textContent = (MAX_PARTICLES/1000).toFixed(0) + 'K';
            }
            
            // ==================== –ê–ù–ê–õ–ò–ó –í–ò–î–ï–û ====================
            function analyzeVideoFrame() {
                if (!state.videoActive || video.paused || video.ended) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = VIDEO_WIDTH;
                canvas.height = VIDEO_HEIGHT;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
                
                const frameData = ctx.getImageData(0, 0, VIDEO_WIDTH, VIDEO_HEIGHT).data;
                
                for (let i = 0; i < MAX_PARTICLES; i++) {
                    const noise = whiteNoise[i];
                    
                    const imgX = Math.floor(((noise.rx / 900) + 0.5) * VIDEO_WIDTH);
                    const imgY = Math.floor(((noise.ry / 280) + 0.5) * VIDEO_HEIGHT);
                    
                    if (imgX >= 0 && imgX < VIDEO_WIDTH && imgY >= 0 && imgY < VIDEO_HEIGHT) {
                        const idx = (imgY * VIDEO_WIDTH + imgX) * 4;
                        
                        particles[i].r = frameData[idx];
                        particles[i].g = frameData[idx + 1];
                        particles[i].b = frameData[idx + 2];
                        
                        const brightness = (frameData[idx] + frameData[idx + 1] + frameData[idx + 2]) / (3 * 255);
                        particles[i].depth = brightness;
                    }
                }
            }
            
            // ==================== –ê–ù–ê–õ–ò–ó –ê–£–î–ò–û ====================
            function analyzeAudio() {
                if (!state.audioActive || !analyser) return;
                
                try {
                    analyser.getByteFrequencyData(state.frequencies);
                    
                    // –ì—Ä–æ–º–∫–æ—Å—Ç—å (—Å—Ä–µ–¥–Ω–µ–µ –ø–æ –≤—Å–µ–º —á–∞—Å—Ç–æ—Ç–∞–º)
                    let sum = 0;
                    for (let i = 0; i < state.frequencies.length; i++) {
                        sum += state.frequencies[i];
                    }
                    state.volume = sum / (state.frequencies.length * 255) * 100;
                    
                    // –ë–∞—Å—ã (0-100)
                    let bassSum = 0;
                    for (let i = 0; i < 100; i++) {
                        bassSum += state.frequencies[i];
                    }
                    state.bass = bassSum / (100 * 255) * 100;
                    
                    // –°—Ä–µ–¥–Ω–∏–µ (100-300)
                    let midSum = 0;
                    for (let i = 100; i < 300; i++) {
                        midSum += state.frequencies[i];
                    }
                    state.mid = midSum / (200 * 255) * 100;
                    
                    // –í—ã—Å–æ–∫–∏–µ (300-512)
                    let highSum = 0;
                    for (let i = 300; i < 512; i++) {
                        highSum += state.frequencies[i];
                    }
                    state.high = highSum / (212 * 255) * 100;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    document.getElementById('volume').textContent = Math.round(state.volume) + '%';
                    document.getElementById('bass').textContent = Math.round(state.bass) + '%';
                    document.getElementById('mid').textContent = Math.round(state.mid) + '%';
                    document.getElementById('high').textContent = Math.round(state.high) + '%';
                    
                } catch (e) {}
            }
            
            // ==================== –°–û–ó–î–ê–ù–ò–ï –°–§–ï–† ====================
            function rebuildSpheres() {
                for (let i = 0; i < spheres.length; i++) {
                    scene.remove(spheres[i]);
                }
                spheres.length = 0;
                
                const batchSize = 2000;
                let current = 0;
                
                function createBatch() {
                    const end = Math.min(current + batchSize, MAX_PARTICLES);
                    
                    for (let i = current; i < end; i++) {
                        const material = new THREE.MeshPhongMaterial({
                            emissiveIntensity: 0.2,
                            transparent: true,
                            opacity: 0.9
                        });
                        const sphere = new THREE.Mesh(sphereGeom, material);
                        sphere.userData.index = i;
                        scene.add(sphere);
                        spheres.push(sphere);
                    }
                    
                    current = end;
                    
                    if (current < MAX_PARTICLES) {
                        setTimeout(createBatch, 0);
                    }
                }
                
                createBatch();
            }
            
            // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï 3D ====================
            function update3D() {
                for (let i = 0; i < spheres.length; i++) {
                    const sphere = spheres[i];
                    const noise = whiteNoise[i];
                    const p = particles[i];
                    
                    p.phase += 0.015;
                    
                    const px = noise.rx / 38 + Math.sin(p.phase) * 0.15;
                    const pz = noise.ry / 19 + Math.cos(p.phase * 1.2) * 0.15;
                    
                    // –í—ã—Å–æ—Ç–∞ –æ—Ç –≤–∏–¥–µ–æ
                    let py = (p.depth - 0.5) * 9;
                    
                    // ===== –ê–£–î–ò–û –≠–§–§–ï–ö–¢–´ =====
                    if (state.audioActive && state.frequencies) {
                        // –ö–∞–∂–¥–∞—è —á–∞—Å—Ç–∏—Ü–∞ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–≤–æ—é —á–∞—Å—Ç–æ—Ç—É
                        const freqIndex = i % state.frequencies.length;
                        const audioValue = state.frequencies[freqIndex] / 255;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Ä–µ–∑–µ—Ä–≤ –∫–∞–Ω–≤–∞—Å–∞
                        p.freqResponse = audioValue;
                        
                        // 1. –ë–∞—Å—ã (0-100) –ø–æ–¥–Ω–∏–º–∞—é—Ç –≤—ã—à–µ
                        if (freqIndex < 100) {
                            py += audioValue * 8;
                        }
                        // 2. –°—Ä–µ–¥–Ω–∏–µ (100-300) –¥–æ–±–∞–≤–ª—è—é—Ç –∫–æ–ª–µ–±–∞–Ω–∏—è
                        else if (freqIndex < 300) {
                            py += Math.sin(p.phase * 10 + audioValue * 20) * audioValue * 4;
                        }
                        // 3. –í—ã—Å–æ–∫–∏–µ (300-512) –¥–æ–±–∞–≤–ª—è—é—Ç –¥—Ä–æ–∂–∞–Ω–∏–µ
                        else {
                            py += Math.sin(p.phase * 30) * audioValue * 2;
                        }
                        
                        // –¶–≤–µ—Ç –æ—Ç –∞—É–¥–∏–æ
                        p.r = Math.min(255, p.r + audioValue * 100);
                        p.g = Math.min(255, p.g + audioValue * 50);
                        p.b = Math.min(255, p.b + audioValue * 150);
                    }
                    
                    sphere.position.set(px, py, pz);
                    sphere.material.color.setRGB(p.r/255, p.g/255, p.b/255);
                    
                    // –†–∞–∑–º–µ—Ä –æ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏—Ü—ã)
                    if (state.audioActive && state.frequencies) {
                        const freqIndex = i % state.frequencies.length;
                        const audioValue = state.frequencies[freqIndex] / 255;
                        sphere.scale.set(1 + audioValue, 1 + audioValue, 1 + audioValue);
                    } else {
                        sphere.scale.set(1, 1, 1);
                    }
                }
            }
            
            // ==================== –†–ò–°–û–í–ê–ù–ò–ï –†–ï–ó–ï–†–í–ê ====================
            function drawReserve() {
                const w = reserveCanvas.width;
                const h = reserveCanvas.height;
                
                reserveCtx.fillStyle = '#0a0a1a';
                reserveCtx.fillRect(0, 0, w, h);
                
                // –í–ò–î–ï–û
                if (state.videoActive && video.videoWidth) {
                    reserveCtx.drawImage(video, 0, 0, w, h);
                }
                
                // –ß–ê–°–¢–ò–¶–´
                const centerX = w/2;
                const centerY = h/2;
                
                for (let i = 0; i < MAX_PARTICLES; i += 3) {
                    const noise = whiteNoise[i];
                    const p = particles[i];
                    
                    const x = centerX + noise.rx * 0.8;
                    const y = centerY + noise.ry * 1.2;
                    
                    if (x < 0 || x > w || y < 0 || y > h) continue;
                    
                    // –†–∞–∑–º–µ—Ä –æ—Ç –≤–∏–¥–µ–æ + –∞—É–¥–∏–æ
                    let size = 1.2 + p.depth * 2;
                    if (state.audioActive) {
                        size += p.freqResponse * 4;
                    }
                    
                    reserveCtx.fillStyle = `rgb(${Math.floor(p.r)}, ${Math.floor(p.g)}, ${Math.floor(p.b)})`;
                    reserveCtx.beginPath();
                    reserveCtx.arc(x, y, size, 0, Math.PI * 2);
                    reserveCtx.fill();
                }
            }
            
            // ==================== –ê–£–î–ò–û –§–£–ù–ö–¶–ò–ò ====================
            async function initAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 1024;
                    analyser.smoothingTimeConstant = 0.8; // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                }
                
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                return audioContext;
            }
            
            // ==================== –í–ò–î–ï–û ====================
            document.getElementById('uploadVideoBtn').addEventListener('click', () => {
                document.getElementById('videoInput').click();
            });
            
            document.getElementById('videoInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const url = URL.createObjectURL(file);
                video.src = url;
                video.load();
                
                state.videoActive = true;
                document.getElementById('videoStatus').textContent = '–∑–∞–≥—Ä—É–∂–µ–Ω–æ';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ –¥–ª—è –≤–∏–¥–µ–æ
                await initAudio();
                
                video.play().catch(() => {
                    document.getElementById('videoStatus').textContent = '–∂–º–∏ PLAY';
                });
            });
            
            // ==================== –ê–£–î–ò–û–§–ê–ô–õ (–î–ò–ö–¢–û–§–û–ù) ====================
            document.getElementById('uploadAudioBtn').addEventListener('click', () => {
                document.getElementById('audioInput').click();
            });
            
            document.getElementById('audioInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    document.getElementById('audioStatus').textContent = '–∑–∞–≥—Ä—É–∑–∫–∞...';
                    
                    const ctx = await initAudio();
                    
                    // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                    if (audioSource) {
                        audioSource.disconnect();
                    }
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∞—É–¥–∏–æ
                    if (audioElement) {
                        audioElement.pause();
                        audioElement = null;
                    }
                    
                    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
                    audioElement = new Audio();
                    audioElement.src = URL.createObjectURL(file);
                    audioElement.loop = true;
                    
                    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏
                    await new Promise((resolve, reject) => {
                        audioElement.addEventListener('canplaythrough', resolve, { once: true });
                        audioElement.addEventListener('error', reject, { once: true });
                    });
                    
                    // –°–æ–∑–¥–∞—ë–º –∏—Å—Ç–æ—á–Ω–∏–∫
                    audioSource = ctx.createMediaElementSource(audioElement);
                    audioSource.connect(analyser);
                    analyser.connect(ctx.destination);
                    
                    state.audioActive = true;
                    document.getElementById('audioStatus').textContent = '–∞–∫—Ç–∏–≤–µ–Ω';
                    document.getElementById('audioIndicator').innerHTML = 'üîä –ê–£–î–ò–û';
                    
                    // –ü—Ä–æ–±—É–µ–º –∏–≥—Ä–∞—Ç—å
                    audioElement.play().catch(() => {
                        document.getElementById('audioStatus').textContent = '–∂–º–∏ PLAY';
                    });
                    
                } catch (e) {
                    console.error('Audio error:', e);
                    document.getElementById('audioStatus').textContent = '–æ—à–∏–±–∫–∞';
                }
            });
            
            // ==================== PLAY/PAUSE ====================
            document.getElementById('playBtn').addEventListener('click', () => {
                if (video.src) video.play();
                if (audioElement) audioElement.play();
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                video.pause();
                if (audioElement) audioElement.pause();
            });
            
            // ==================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
            function updateStats() {
                if (state.videoActive) {
                    let avgDepth = 0;
                    for (let i = 0; i < 100; i++) {
                        avgDepth += particles[i * 1600].depth || 0;
                    }
                    avgDepth = avgDepth / 100;
                    document.getElementById('depth').textContent = Math.round(avgDepth * 100) + '%';
                }
                
                state.frameCount++;
                const now = performance.now();
                if (now - state.lastFpsUpdate >= 1000) {
                    state.fps = state.frameCount;
                    state.frameCount = 0;
                    state.lastFpsUpdate = now;
                    document.getElementById('fps').textContent = state.fps;
                }
            }
            
            // ==================== –ê–ù–ò–ú–ê–¶–ò–Ø ====================
            function animate() {
                requestAnimationFrame(animate);
                
                state.time += 0.016;
                
                if (state.videoActive && !video.paused) {
                    analyzeVideoFrame();
                }
                
                analyzeAudio();
                update3D();
                drawReserve();
                
                controls.update();
                renderer.render(scene, camera);
                
                updateStats();
            }
            
            // ==================== –°–¢–ê–†–¢ ====================
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            generateWhiteNoise();
            
            setTimeout(() => {
                rebuildSpheres();
            }, 100);
            
            animate();
        })();
    </script>
</body>
</html>